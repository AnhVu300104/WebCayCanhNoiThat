@model List<Models.EF.ProductVariant>

@{
    ViewBag.Title = "Quản lý biến thể";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    var product = ViewBag.Product as Models.EF.Product;
}

<div class="container-fluid">

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            Biến thể sản phẩm: <span class="text-primary">@product.Name</span>
        </h1>
        <div>
            <a href="@Url.Action("Show", "Product")" class="btn btn-sm btn-secondary shadow-sm mr-2">
                <i class="fas fa-arrow-left fa-sm"></i> Quay lại DS Sản phẩm
            </a>
            <a href="@Url.Action("Create", "Variant", new { productId = product.ProductId })" class="btn btn-sm btn-success shadow-sm">
                <i class="fas fa-plus fa-sm"></i> Thêm biến thể mới
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle mr-2"></i> @TempData["Success"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <div class="card shadow mb-4 border-left-primary">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-auto">
                    <img src="@Url.Content("~/image/" + product.Photo)" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;" onerror="this.src='/Content/images/no-image.png'" />
                </div>
                <div class="col">
                    <div class="font-weight-bold text-gray-800">@product.Name</div>
                    <div class="small text-gray-500">
                        Mã SP gốc: SP@(product.ProductId) |
                        Tổng tồn kho: @ViewBag.TotalStock

                        @* ===== HIỂN THỊ LỖI NẾU CÓ ===== *@
                        @if (ViewBag.StockError != null)
                        {
                            <div class="alert alert-danger mt-2">
                                <strong>🚨 Lỗi tính tồn kho:</strong><br />
                                <code>@ViewBag.StockError</code>
                                @if (ViewBag.StackTrace != null)
                                {
                                    <hr />
                                    <small><pre>@ViewBag.StackTrace</pre></small>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Danh sách phân loại hàng</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                    <thead class="thead-light">
                        <tr>
                            <th width="5%">ID</th>
                            <th width="8%">Ảnh</th>
                            <th width="12%">SKU</th>
                            <th width="20%">Thuộc tính</th>
                            <th width="13%">Giá bán</th>
                            <th width="10%">Kho</th>
                            <th width="8%" class="text-center">Tồn</th>
                            <th width="8%" class="text-center">TT</th>
                            <th width="10%" class="text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            foreach (var item in Model)
                            {
                                <tr>
                                    <td class="text-center">@item.VariantId</td>
                                    <td class="text-center">
                                        @if (!string.IsNullOrEmpty(item.ImageVariant))
                                        {
                                            <img src="@Url.Content("~/image/" + item.ImageVariant)" style="width: 50px; height: 50px; object-fit: cover; border: 1px solid #ddd;" />
                                        }
                                        else
                                        {
                                            <span class="text-muted small">Không có</span>
                                        }
                                    </td>
                                    <td class="font-weight-bold">@item.SKU</td>
                                    <td>
                                        @if (item.VariantAttributeValues != null && item.VariantAttributeValues.Any())
                                        {
                                            foreach (var attr in item.VariantAttributeValues)
                                            {
                                                <span class="badge badge-info mr-1">
                                                    @attr.Attribute.Name: @attr.AttributeValue.Value
                                                </span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted font-italic">Mặc định</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.SalePrice > 0 && item.SalePrice < item.Price)
                                        {
                                            <div class="text-danger font-weight-bold">@string.Format("{0:N0}₫", item.SalePrice)</div>
                                            <div class="text-muted small" style="text-decoration: line-through;">@string.Format("{0:N0}₫", item.Price)</div>
                                        }
                                        else
                                        {
                                            <div class="font-weight-bold">@string.Format("{0:N0}₫", item.Price)</div>
                                        }
                                    </td>
                                    <!-- ===== THÊM MỚI: Hiển thị tên kho ===== -->
                                    <td>
                                        @if (item.Warehouse != null)
                                        {
                                            <span class="badge badge-secondary">
                                                <i class="fas fa-warehouse"></i> @item.Warehouse.Name
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small font-italic">Chưa chọn</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (item.StockQuantity > 0)
                                        {
                                            <span class="badge badge-light border">@item.StockQuantity</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-danger">Hết</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (item.IsActive == true)
                                        {
                                            <i class="fas fa-check-circle text-success" title="Đang bán"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-times-circle text-secondary" title="Ngừng"></i>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <a href="@Url.Action("Edit", "Variant", new { id = item.VariantId })" class="btn btn-primary btn-sm" title="Sửa">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="9" class="text-center py-4 text-muted">
                                    Chưa có biến thể nào. Hãy thêm mới!
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="~/Areas/Admin/Content/vendor/datatables/jquery.dataTables.min.js"></script>
<script src="~/Areas/Admin/Content/vendor/datatables/dataTables.bootstrap4.min.js"></script>

<script>
    $(document).ready(function () {
        $('#dataTable').DataTable({
            "language": {
                "search": "Tìm kiếm:",
                "lengthMenu": "Hiển thị _MENU_ dòng",
                "info": "Trang _PAGE_ / _PAGES_",
                "zeroRecords": "Không tìm thấy dữ liệu",
                "paginate": { "next": "Sau", "previous": "Trước" }
            },
            "order": [[0, "desc"]]
        });
    });
</script>