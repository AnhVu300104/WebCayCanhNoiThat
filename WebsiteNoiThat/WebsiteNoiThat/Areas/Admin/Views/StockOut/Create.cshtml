@model Models.EF.StockOut

@{
    ViewBag.Title = "Tạo phiếu xuất kho";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<style>
    .search-result-box {
        position: absolute;
        z-index: 1000;
        background: white;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 0 0 5px 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: none;
    }

    .search-item {
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

        .search-item:hover {
            background-color: #f8f9fc;
        }

        .search-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }

        .search-item .info {
            flex: 1;
        }

        .search-item .sku {
            font-size: 0.85rem;
            color: #888;
            font-weight: bold;
        }

    .stock-ok {
        color: #28a745;
        font-weight: bold;
    }

    .stock-low {
        color: #ffc107;
        font-weight: bold;
    }

    .stock-out {
        color: #dc3545;
        font-weight: bold;
    }
</style>

@using (Html.BeginForm("Create", "StockOut", FormMethod.Post, new { id = "form-stock-out" }))
{
    @Html.AntiForgeryToken()
    @Html.HiddenFor(model => model.StockOutId)
    @Html.HiddenFor(model => model.Code)
    @Html.HiddenFor(model => model.Status)
    @Html.HiddenFor(model => model.CreatedBy)
    @Html.HiddenFor(model => model.CreatedAt)
    <input type="hidden" name="stockDetailsJson" id="stockDetailsJson" />

    <div class="container-fluid">
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Tạo Phiếu Xuất Kho</h1>
            <a href="@Url.Action("Index", "StockOut")" class="btn btn-sm btn-secondary shadow-sm">
                <i class="fas fa-arrow-left fa-sm"></i> Quay lại
            </a>
        </div>

        <div class="row">
            <!-- Thông tin phiếu -->
            <div class="col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Thông tin phiếu</h6>
                    </div>
                    <div class="card-body">
                        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                        <div class="form-group">
                            <label class="control-label font-weight-bold">Kho xuất <span class="text-danger">*</span></label>
                            @Html.DropDownListFor(model => model.WarehouseId, ViewBag.Warehouses as SelectList, "--- Chọn kho ---", new { @class = "form-control", @required = "required" })
                            @Html.ValidationMessageFor(model => model.WarehouseId, "", new { @class = "text-danger" })
                        </div>

                        @*<div class="form-group">
                            <label class="control-label font-weight-bold">Xuất theo Đơn hàng (Optional)</label>
                            @Html.DropDownList("OrderId", ViewBag.Orders as SelectList, "--- Chọn đơn hàng (nếu có) ---", new { @class = "form-control" })
                            <small class="text-muted">Chọn đơn hàng để tự động điền sản phẩm.</small>
                        </div>*@

                        <div class="form-group">
                            <label class="control-label font-weight-bold">Loại xuất</label>
                            @Html.DropDownListFor(model => model.Type, new List<SelectListItem>
                            {
                                //new SelectListItem { Text = "Xuất bán hàng", Value = "Sale", Selected = true },
                                new SelectListItem { Text = "Xuất chuyển kho", Value = "Transfer" },
                                new SelectListItem { Text = "Xuất hủy/hỏng", Value = "Damaged" },
                                new SelectListItem { Text = "Xuất khác", Value = "Other" }
                            }, new { @class = "form-control" })
                        </div>

                        <div class="form-group">
                            <label class="control-label font-weight-bold">Ghi chú</label>
                            @Html.TextAreaFor(model => model.Note, new { @class = "form-control", rows = "4", placeholder = "Ghi chú xuất kho..." })
                        </div>

                        <hr />
                        <div class="form-group">
                            <button type="button" id="btn-submit" class="btn btn-success btn-block btn-lg">
                                <i class="fas fa-save"></i> LƯU PHIẾU XUẤT
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chi tiết sản phẩm -->
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 bg-light">
                        <h6 class="m-0 font-weight-bold text-primary">Chi tiết sản phẩm xuất</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3 bg-white p-3 border rounded">
                            <div class="col-md-5 position-relative">
                                <label class="small font-weight-bold">Tìm sản phẩm (Tên/SKU)</label>
                                <input type="text" id="product-search" class="form-control" placeholder="Gõ để tìm kiếm..." autocomplete="off">
                                <input type="hidden" id="selected-variant-id">
                                <div id="search-results" class="search-result-box"></div>
                            </div>
                            <div class="col-md-2">
                                <label class="small font-weight-bold">Tồn kho</label>
                                <input type="text" id="current-stock" class="form-control" readonly style="background-color: #f8f9fc;">
                            </div>
                            <div class="col-md-2">
                                <label class="small font-weight-bold">Số lượng xuất</label>
                                <input type="number" id="input-qty" class="form-control" min="1" value="1">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" id="btn-add-row" class="btn btn-primary btn-block">
                                    <i class="fas fa-plus"></i> Thêm
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered table-striped" width="100%">
                                <thead class="thead-dark">
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="10%">Ảnh</th>
                                        <th width="35%">Sản phẩm / SKU</th>
                                        <th width="15%" class="text-center">Tồn kho</th>
                                        <th width="10%" class="text-center">SL Xuất</th>
                                        <th width="15%">Ghi chú</th>
                                        <th width="10%" class="text-center">Xóa</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <tr id="empty-row">
                                        <td colspan="7" class="text-center text-muted">Chưa có sản phẩm nào trong phiếu.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        var productsData = @Html.Raw(ViewBag.ProductJson ?? "[]");
        var stockDetails = @Html.Raw(ViewBag.OriginalStockDetailsJson ?? "[]");

        $(document).ready(function() {

            // --- XỬ LÝ CHỌN ĐƠN HÀNG (AUTO FILL) ---
            $('#OrderId').change(function() {
                var orderId = $(this).val();
                if(!orderId) return;

                if(stockDetails.length > 0) {
                    if(!confirm('Đang có dữ liệu trong bảng. Bạn có muốn xóa đi để load lại theo Đơn hàng này không?')) {
                        $(this).val('');
                        return;
                    }
                }

                $('#table-body').html('<tr><td colspan="7" class="text-center text-primary"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>');

                $.ajax({
                    url: '/Admin/StockOut/GetOrderItems',
                    type: 'GET',
                    data: { orderId: orderId },
                    success: function(res) {
                        if(res.status) {
                            stockDetails = res.data.map(item => ({
                                VariantId: item.VariantId,
                                Quantity: item.Quantity,
                                Note: 'Xuất theo đơn #' + orderId,
                                SKU: item.SKU,
                                ProductName: item.ProductName,
                                Image: item.ImageVariant || 'no-image.png',
                                StockQty: item.StockQty
                            }));
                            renderTable();
                        } else {
                            alert('Lỗi: ' + res.message);
                            renderTable();
                        }
                    },
                    error: function() {
                        alert('Không thể tải chi tiết đơn hàng.');
                        renderTable();
                    }
                });
            });

            // --- TÌM KIẾM SẢN PHẨM ---
            $('#product-search').on('input', function() {
                var keyword = $(this).val().toLowerCase();
                if(keyword.length < 1) {
                    $('#search-results').hide();
                    return;
                }
                var results = productsData.filter(p =>
                    p.ProductName.toLowerCase().includes(keyword) ||
                    p.SKU.toLowerCase().includes(keyword)
                );
                renderSearchResults(results);
            });

            // --- CHỌN SẢN PHẨM TỪ LIST GỢI Ý ---
            $(document).on('click', '.search-item', function() {
                var id = $(this).data('id');
                var product = productsData.find(p => p.VariantId == id);
                if(product) {
                    $('#product-search').val(product.ProductName + ' (' + product.SKU + ')');
                    $('#selected-variant-id').val(product.VariantId);
                    $('#current-stock').val(product.StockQty);
                    $('#search-results').hide();
                    $('#input-qty').focus();
                }
            });

            $(document).click(function(e) {
                if (!$(e.target).closest('#product-search, #search-results').length) {
                    $('#search-results').hide();
                }
            });

            // --- THÊM DÒNG VÀO BẢNG ---
            $('#btn-add-row').click(function() {
                var variantId = $('#selected-variant-id').val();
                var qty = parseInt($('#input-qty').val());
                var currentStock = parseInt($('#current-stock').val());

                if(!variantId) { alert('Vui lòng chọn sản phẩm!'); return; }
                if(qty <= 0) { alert('Số lượng phải lớn hơn 0!'); return; }

                // ✅ KIỂM TRA TỒN KHO
                if(qty > currentStock) {
                    alert(`⚠️ CẢNH BÁO: Không đủ tồn kho!\nTồn hiện tại: ${currentStock}\nSố lượng xuất: ${qty}`);
                    return;
                }

                var existingItem = stockDetails.find(x => x.VariantId == variantId);
                if(existingItem) {
                    if(confirm('Sản phẩm này đã có trong danh sách. Cộng dồn số lượng?')) {
                        var newQty = existingItem.Quantity + qty;
                        if(newQty > currentStock) {
                            alert(`⚠️ Tổng số lượng sau khi cộng (${newQty}) vượt quá tồn kho (${currentStock})!`);
                            return;
                        }
                        existingItem.Quantity = newQty;
                        renderTable();
                        resetInput();
                    }
                    return;
                }

                var productInfo = productsData.find(p => p.VariantId == variantId);

                stockDetails.push({
                    VariantId: parseInt(variantId),
                    Quantity: qty,
                    Note: '',
                    SKU: productInfo.SKU,
                    ProductName: productInfo.ProductName,
                    Image: productInfo.ImageVariant || 'no-image.png',
                    StockQty: currentStock
                });

                renderTable();
                resetInput();
            });

            // --- XÓA DÒNG ---
            $(document).on('click', '.btn-remove-row', function() {
                var index = $(this).data('index');
                stockDetails.splice(index, 1);
                renderTable();
            });

            // --- SUBMIT FORM ---
            $('#btn-submit').click(function() {
                if(stockDetails.length === 0) {
                    alert('Vui lòng thêm ít nhất một sản phẩm!');
                    return;
                }

                // ✅ KIỂM TRA TỒN KHO TRƯỚC KHI SUBMIT
                var errors = [];
                stockDetails.forEach(item => {
                    if(item.Quantity > item.StockQty) {
                        errors.push(`${item.SKU}: Xuất ${item.Quantity}, Tồn ${item.StockQty}`);
                    }
                });

                if(errors.length > 0) {
                    alert('⚠️ Các sản phẩm sau không đủ tồn kho:\n' + errors.join('\n'));
                    return;
                }

                $('#stockDetailsJson').val(JSON.stringify(stockDetails));
                $('#form-stock-out').submit();
            });

            renderTable();
        });

        function renderSearchResults(results) {
            var html = '';
            if(results.length > 0){
                results.forEach(p => {
                    var stockClass = p.StockQty > 10 ? 'stock-ok' : (p.StockQty > 0 ? 'stock-low' : 'stock-out');
                    var stockText = p.StockQty > 0 ? `Tồn: ${p.StockQty}` : 'Hết hàng';

                    html += `<div class="search-item" data-id="${p.VariantId}">
                        <img src="/image/${p.ImageVariant || 'no-image.png'}" onerror="this.src='/Content/images/no-image.png'">
                        <div class="info">
                            <div class="font-weight-bold">${p.ProductName}</div>
                            <div class="sku">SKU: ${p.SKU} | <span class="${stockClass}">${stockText}</span></div>
                        </div>
                    </div>`;
                });
                $('#search-results').html(html).show();
            } else {
                $('#search-results').html('<div class="p-3 text-muted text-center">Không tìm thấy sản phẩm</div>').show();
            }
        }

        function renderTable() {
            var tbody = $('#table-body');
            tbody.empty();
            if(stockDetails.length === 0){
                tbody.html('<tr id="empty-row"><td colspan="7" class="text-center text-muted">Chưa có sản phẩm nào.</td></tr>');
                return;
            }

            stockDetails.forEach((item, index) => {
                var stockClass = item.Quantity > item.StockQty ? 'stock-out' : (item.StockQty > 10 ? 'stock-ok' : 'stock-low');
                var stockBadge = `<span class="${stockClass}">${item.StockQty}</span>`;

                tbody.append(`<tr>
                    <td>${index+1}</td>
                    <td><img src="/image/${item.Image}" style="width:40px;height:40px;object-fit:cover;" onerror="this.src='/Content/images/no-image.png'"></td>
                    <td><div class="font-weight-bold text-primary">${item.SKU}</div><div class="small">${item.ProductName}</div></td>
                    <td class="text-center">${stockBadge}</td>
                    <td class="text-center"><span class="badge badge-secondary" style="font-size:1rem;">${item.Quantity}</span></td>
                    <td><input type="text" class="form-control form-control-sm" value="${item.Note || ''}" onchange="updateNote(${index}, this.value)"></td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm btn-circle btn-remove-row" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`);
            });
        }

        function resetInput() {
            $('#product-search').val('').focus();
            $('#selected-variant-id').val('');
            $('#current-stock').val('');
            $('#input-qty').val(1);
        }

        window.updateNote = function(index, val) {
            stockDetails[index].Note = val;
        }
    </script>
}